
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Janus Streaming Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .stream-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    .stream-box {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      width: 640px;
    }
    video {
      width: 100%;
      height: 360px;
      background-color: black;
    }
    .stream-info {
      padding: 10px 0;
      font-weight: bold;
    }
    .stream-controls {
      margin-top: 10px;
    }
    button {
      padding: 8px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    button.stop {
      background-color: #f44336;
    }
    button.stop:hover {
      background-color: #d32f2f;
    }
  </style>
</head>
<body>
  <h1>Janus Streaming Dashboard</h1>
  <div id="status">Connessione al server Janus...</div>
  <div id="streams-list">Caricamento stream disponibili...</div>
  
  <div class="stream-container" id="streams-container">
    <!-- Gli stream verranno aggiunti qui dinamicamente -->
  </div>


  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
  <script  src="{{ url_for('static', filename='./node_modules/janus-gateway/npm/src/janus.js') }}""></script>
  
  <script>
    let janus = null;
    let streaming = null;
    let activeStreams = {};

    function updateStatus(message, isError = false) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.style.color = isError ? 'red' : 'inherit';
    }

    function createStreamElement(streamInfo) {
      const streamId = streamInfo.id;
      const container = document.createElement('div');
      container.className = 'stream-box';
      container.id = `stream-${streamId}`;
      
      container.innerHTML = `
        <div class="stream-info">Stream ${streamId}: ${streamInfo.description || 'Nessuna descrizione'}</div>
        <video id="video-${streamId}" playsinline autoplay muted></video>
        <div class="stream-controls">
          <button onclick="watchStream(${streamId})">Avvia</button>
          <button class="stop" onclick="stopStream(${streamId})">Ferma</button>
        </div>
      `;
      
      document.getElementById('streams-container').appendChild(container);
      return container;
    }

    function watchStream(streamId) {
  if (activeStreams[streamId]) {
    console.log(`Stream ${streamId} giÃ  attivo`);
    return;
  }

  updateStatus(`Avvio stream ${streamId}...`);

  janus.attach({
    plugin: "janus.plugin.streaming",
    success: function(pluginHandle) {
      activeStreams[streamId] = {
        handle: pluginHandle,
        watching: true
      };

      pluginHandle.send({
        message: { request: "watch", id: streamId }
      });
    },
    error: function(error) {
      console.error(`Errore attacco stream ${streamId}:`, error);
      updateStatus(`Errore nell'attacco dello stream ${streamId}`, true);
    },
    onmessage: function(msg, jsep) {
      if (jsep) {
        activeStreams[streamId].handle.createAnswer({
          jsep: jsep,
          media: {
            audioSend: false,
            videoSend: false,
            audioRecv: msg.type === 'rtp' ? true : false,
            videoRecv: true
          },
          success: function(jsep) {
            const body = { request: "start" };
            activeStreams[streamId].handle.send({ message: body, jsep: jsep });
          },
          error: function(error) {
            console.error("Errore creazione answer:", error);
          }
        });
      }
    },
    onremotetrack: function(track, mid, flow) {
      console.log(`Stream remoto ricevuto per ID ${streamId}`);
      handleRemoteStream(streamId, track);
    },
    oncleanup: function() {
      console.log(`Pulizia stream ${streamId}`);
    }
  });
}
    


function stopStream(streamId) {
  const stream = activeStreams[streamId];
  if (!stream) return;

  stream.handle.send({
    message: { request: "stop" },
    success: function() {
      stream.handle.detach();
      delete activeStreams[streamId];
      const videoElement = document.getElementById(`video-${streamId}`);
      if (videoElement) {
        videoElement.srcObject = null;
      }
      updateStatus(`Stream ${streamId} arrestato`);
    },
    error: function(error) {
      console.error(`Errore arresto stream ${streamId}:`, error);
      updateStatus(`Errore nell'arresto dello stream ${streamId}`, true);
    }
  });
}



    function handleRemoteStream(streamId, stream) {
      const videoElement = document.getElementById(`video-${streamId}`);
      if (videoElement) {
        Janus.attachMediaStream(videoElement, new MediaStream([stream]));
        updateStatus(`Stream ${streamId} attivo`);
      }
    }

    Janus.init({
      debug: "all",
      callback: function() {
        updateStatus("Connessione al server Janus...");
        
        janus = new Janus({
          server: "ws://10.0.0.254:8188/",
          success: function() {
            updateStatus("Connesso al server Janus. Attacco plugin streaming...");
            
            janus.attach({
              plugin: "janus.plugin.streaming",
              success: function(pluginHandle) {
                streaming = pluginHandle;
                updateStatus("Plugin streaming pronto. Recupero lista stream...");
                
                // Richiedi la lista degli stream
                streaming.send({ 
                  message: { request: "list" },
                  success: function(result) {
                    if(result && result.list) {
                      console.log(result)
                      updateStatus(`${result.list.length} stream disponibili`);
                      document.getElementById('streams-list').textContent = 
                        `Stream disponibili: ${result.list.length}`;
                      
                      // Crea un elemento per ogni stream
                      result.list.forEach(stream => {
                        createStreamElement(stream);
                      });
                    }
                  },
                  error: function(error) {
                    console.error("Errore lista stream:", error);
                    updateStatus("Errore nel recuperare la lista degli stream", true);
                  }
                });
              },
              error: function(error) {
                console.error("Errore plugin streaming:", error);
                updateStatus("Errore nell'attaccare il plugin streaming", true);
              },
              onmessage: function(msg, jsep) {
                if(msg.list) {
                  // Risposta alla lista degli stream
                  console.log("Lista stream ricevuta:", msg.list);
                } else if (jsep) {
                  // Offerta SDP per lo streaming
                  console.log("Ricevuta offerta SDP per stream");
                  console.log(msg)
                  streaming.createAnswer({
                    jsep: jsep,
                    media: { 
                      audioSend: false, 
                      videoSend: false, 
                      audioRecv: msg.type === 'rtp' ? true : false, 
                      videoRecv: true 
                    },
                    success: function(jsep) {
                      console.log("answeer created")
                      const body = { request: "start" };
                      streaming.send({ message: body, jsep: jsep });
                    },
                    error: function(error) {
                      console.error("Errore creazione answer:", error);
                    }
                  });
                }
              },
              onremotetrack: function(stream) {
                // Determina l'ID dello stream dal media stream (potrebbe richiedere adattamento)
                const streamId = Object.keys(activeStreams).find(id => activeStreams[id].watching);
                if(streamId) {
                  console.log(`Ricevuto stream remoto per ID ${streamId}`);
                  console.log(stream);
                  handleRemoteStream(streamId, stream);
                }
              },
              oncleanup: function() {
                console.log("Cleanup stream");
              },
            });
          },
          error: function(error) {
            console.error("Errore connessione Janus:", error);
            updateStatus("Errore nella connessione al server Janus", true);
          },
          destroyed: function() {
            console.log("Janus destroyed");
          }
        });
      }
    });
  </script>
</body>
</html>